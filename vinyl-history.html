<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artist Printing - Vinyl Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f172a] font-sans text-white min-h-screen p-6 md:p-12">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
            <div>
                <h1 class="text-3xl font-black italic uppercase tracking-tighter text-blue-500">Vinyl Archive</h1>
                <p class="text-xs text-slate-400 uppercase tracking-widest mt-1">Global History (Rolls & Banners)</p>
            </div>
            <button onclick="window.location.href='index.html'" class="bg-slate-800 hover:bg-slate-700 px-6 py-3 rounded-xl font-bold text-xs uppercase tracking-widest transition-all">
                ← Home
            </button>
        </div>

        <div id="loader" class="text-center py-20 text-slate-600 animate-pulse">Loading Archive...</div>
        <div id="historyContainer" class="space-y-4 hidden"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qenxaqprgrbrapsuqfch.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlbnhhcXByZ3JicmFwc3VxZmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2Nzg5ODksImV4cCI6MjA4MjI1NDk4OX0.P4faPhpEHfu3Rzq4aiNJ8HjIvupJAu7rnQAdhXVs3Ng';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        window.onload = async () => {
            try {
                const { data, error } = await _supabase
                    .from('quote_history')
                    .select('*')
                    .in('category', ['Vinyl', 'Banners'])
                    .order('created_at', { ascending: false })
                    .limit(50);

                document.getElementById('loader').classList.add('hidden');
                const container = document.getElementById('historyContainer');
                container.classList.remove('hidden');

                if (error) throw error;
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-600 py-10">No history found.</div>';
                    return;
                }

                container.innerHTML = data.map(q => {
                    const dateObj = new Date(q.created_at);
                    const dateStr = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
                    const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Fallback for Tax calculation on old data
                    const finalWithTax = q.total_with_tax ? q.total_with_tax : (q.price * 1.20);

                    return `
                    <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:border-blue-500/50 transition-colors group">
                        
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="bg-blue-900/50 text-blue-200 px-2 py-1 rounded text-[9px] font-bold uppercase tracking-wider border border-blue-800">
                                    ${q.category || 'Vinyl'}
                                </span>
                                <span class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">${dateStr} • ${timeStr}</span>
                                <span class="text-slate-600 text-[10px] font-bold uppercase tracking-widest border-l border-slate-800 pl-3">By: ${q.staff}</span>
                            </div>
                            <h3 class="text-xl font-black uppercase text-white tracking-tight">${q.customer}</h3>
                            <p class="text-xs text-slate-400 mt-1 uppercase tracking-wide">
                                ${q.type} <span class="text-slate-600 mx-1">|</span> Tier: ${q.range}
                            </p>
                        </div>

                        <div class="text-right flex flex-col items-end min-w-[140px]">
                            <span class="block text-3xl font-black text-blue-400 italic">£${q.price}</span>
                            <span class="block text-xs font-bold text-slate-500 mt-1 mb-2">£${Number(finalWithTax).toFixed(2)} (inc. TAX)</span>
                            
                            <span class="text-[10px] text-green-500 font-bold uppercase tracking-widest bg-green-900/20 px-2 py-1 rounded mb-1">
                                Billed: ${q.details}
                            </span>
                            <span class="text-[9px] text-slate-600 uppercase tracking-widest">
                                Input: ${q.original}
                            </span>
                        </div>
                    </div>
                    `;
                }).join('');

            } catch (e) {
                console.error(e);
                document.getElementById('loader').innerText = "Unable to load history (Offline?)";
            }
        };
    </script>
</body>
</html>