<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artist Printing - Vinyl Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .error-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Blueprint Background Pattern */
        .blueprint-grid {
            background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-gray-50/50 font-sans text-slate-900 min-h-screen">

<section class="p-6 md:p-10 flex flex-col justify-center min-h-screen">
    <div class="max-w-6xl mx-auto w-full"> <div class="flex items-center justify-between mb-8 px-4">
            <button onclick="window.location.href='index.html'" class="text-xs font-bold text-slate-400 hover:text-blue-600 uppercase tracking-widest transition-all">‚Üê Back to Reception</button>
            <div class="flex items-center gap-2">
                <span class="text-xl opacity-50">üñ®Ô∏è</span>
                <h2 class="text-xs font-black text-blue-600 uppercase tracking-widest italic font-bold">Vinyl & Banner Engine</h2>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="w-full lg:w-1/3 bg-white p-8 rounded-[40px] shadow-2xl border border-gray-200 space-y-6 h-fit">
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-2xl flex justify-between items-center">
                    <div>
                        <p class="text-[10px] uppercase font-bold text-slate-400">Customer</p>
                        <p id="displayCustomer" class="font-black text-slate-900 uppercase">---</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] uppercase font-bold text-slate-400">Staff</p>
                        <p id="displayStaff" class="font-bold text-blue-600">---</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Material Category</label>
                        <select id="material" onchange="updateTypes()" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:border-blue-500 transition-all cursor-pointer text-sm font-bold">
                            <option value="" selected disabled>Select Category...</option>
                            <option value="Vinyl">Vinyl Printing</option>
                            <option value="Banners">Banners (Roll)</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Type Option <span class="text-red-500">*</span></label>
                        <select id="materialType" disabled class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:border-blue-500 cursor-pointer disabled:opacity-50 transition-all text-sm">
                            <option value="" selected disabled>Select material first</option>
                        </select>
                    </div>

                    <div class="flex items-end gap-2">
                        <div class="flex-1 space-y-1">
                            <label class="text-[10px] font-bold text-blue-600 uppercase ml-1 font-bold">Input Height <span class="text-red-500">*</span></label>
                            <input type="number" id="height" min="0" step="0.01" oninput="validity.valid||(value='');" class="w-full p-4 bg-gray-50 border-2 border-blue-50 rounded-2xl outline-none focus:border-blue-500 transition-all font-bold" placeholder="0.00">
                        </div>
                        <div class="w-28 space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Units</label>
                            <select id="units" class="w-full p-4 bg-white border-2 border-blue-500 rounded-2xl font-bold text-blue-600 outline-none cursor-pointer">
                                <option value="mm">MM</option><option value="cm">CM</option><option value="m">M</option><option value="ft" selected>FT</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Pricing Range <span class="text-red-500">*</span></label>
                        <select id="range" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none font-bold focus:border-blue-500 cursor-pointer transition-all text-sm">
                            <option value="" selected disabled>Select Tier</option>
                            <option value="High">High Range</option>
                            <option value="Medium">Medium Range</option>
                            <option value="Low">Low Range</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="calculateQuote()" class="bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl shadow-xl uppercase text-xs tracking-widest transition-all active:scale-95">Calculate</button>
                    <button onclick="softReset()" class="bg-gray-100 hover:bg-gray-200 text-slate-500 font-bold py-4 rounded-xl uppercase text-xs tracking-widest">Clear</button>
                </div>
            </div>

            <div class="flex-1 bg-[#0f172a] text-white p-8 rounded-[45px] shadow-2xl flex flex-col border border-slate-800 min-h-[600px] relative overflow-hidden">
                
                <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center opacity-20 italic text-sm pointer-events-none">
                    <span class="text-4xl mb-2">üìê</span>
                    <p>Visualizer Waiting...</p>
                </div>
                
                <div id="quoteResult" class="hidden flex flex-col h-full relative z-10">
                    
                    <div class="w-full h-64 bg-slate-900/50 rounded-3xl border-2 border-dashed border-slate-700 mb-6 relative flex items-center justify-center blueprint-grid overflow-hidden group">
                        
                        <div id="visualShape" class="bg-blue-500/20 border-2 border-blue-400 transition-all duration-700 relative shadow-[0_0_30px_rgba(59,130,246,0.2)] flex items-center justify-center">
                            
                            <div class="absolute -top-6 left-0 w-full text-center text-[10px] text-blue-300 font-mono">Width: <span id="visWidth">--</span></div>
                            <div class="absolute -left-8 top-0 h-full flex items-center text-[10px] text-blue-300 font-mono rotate-180" style="writing-mode: vertical-rl;">Height: <span id="visHeight">--</span></div>
                            
                            <div class="text-center">
                                <span class="text-2xl opacity-50">üí†</span>
                            </div>
                        </div>

                        <button onclick="alert('Design Studio Engine is under construction. Future feature: Drag, Drop, Cut & Nesting.')" class="absolute bottom-4 right-4 bg-slate-800 hover:bg-blue-600 text-xs px-4 py-2 rounded-full font-bold uppercase tracking-wider transition-colors border border-slate-600 hover:border-blue-400 opacity-0 group-hover:opacity-100">
                            ‚úèÔ∏è Edit Shape
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                            <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Total Area (A.C.)</p>
                            <p id="resArea" class="text-xl font-black text-white">0.00 m¬≤</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700 text-right">
                            <p class="text-[9px] text-slate-400 font-bold uppercase mb-1">Roll Width</p>
                            <p id="resRollWidth" class="text-xl font-black text-blue-400">--</p>
                        </div>
                    </div>

                    <div class="mt-auto border-t border-slate-800 pt-6">
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-1">Billed Length</p>
                                <p id="resRounded" class="text-sm font-mono text-green-400">--</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em] mb-1">Net Amount</p>
                                <div id="resTotal" class="text-5xl font-black text-white tracking-tighter italic leading-none">¬£0.00</div>
                                <div id="resTax" class="text-sm font-bold text-blue-400 mt-2 tracking-tight">¬£0.00 (inc. TAX)</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button onclick="window.print()" class="flex-1 bg-white hover:bg-gray-200 text-slate-900 py-4 rounded-xl font-black uppercase tracking-widest shadow-lg transition-all text-xs">Print</button>
                    </div>
                    <p id="saveStatus" class="text-[9px] text-center mt-3 text-slate-600 uppercase tracking-widest opacity-0 transition-opacity">Saving...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
const SUPABASE_URL = 'https://qenxaqprgrbrapsuqfch.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlbnhhcXByZ3JicmFwc3VxZmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2Nzg5ODksImV4cCI6MjA4MjI1NDk4OX0.P4faPhpEHfu3Rzq4aiNJ8HjIvupJAu7rnQAdhXVs3Ng';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const materialData = {
    "Vinyl": {
        "mono 1370": { widthFt: 4.5, prices: { High: 42.75, Medium: 28.50, Low: 24.23 } },
        "mono maric 1050": { widthFt: 3.5, prices: { High: 42.51, Medium: 28.34, Low: 24.09 } },
        "mono 1600": { widthFt: 5.0, prices: { High: 44.10, Medium: 29.40, Low: 24.99 } },
        "POLYMERIC Vinyl 7 YEAR": { widthFt: 4.5, prices: { High: 50.86, Medium: 33.90, Low: 28.82 } }
    },
    "Banners": {
        "FLEX BANNER": { widthFt: 4.5, prices: { High: 42.31, Medium: 28.21, Low: 23.98 } },
        "flex banner 1.6M": { widthFt: 5.0, prices: { High: 44.16, Medium: 29.44, Low: 25.03 } },
        "Premium 440gsm PVC Banner": { widthFt: 3.5, prices: { High: 41.80, Medium: 27.87, Low: 23.69 } }
    }
};

let session = {};

window.onload = () => {
    const sessionRaw = localStorage.getItem('artist_session');
    if(!sessionRaw) { window.location.href = 'index.html'; return; }
    session = JSON.parse(sessionRaw);
    document.getElementById('displayStaff').innerText = session.staff;
    document.getElementById('displayCustomer').innerText = session.customer;
};

function updateTypes() {
    const mat = document.getElementById('material').value;
    const t = document.getElementById('materialType'); 
    t.innerHTML = '<option value="" selected disabled>Choose Type...</option>'; 
    t.disabled = false;
    t.classList.remove('disabled:opacity-50');
    if(materialData[mat]) {
        Object.keys(materialData[mat]).forEach(k => { 
            const opt = document.createElement("option"); opt.value = k; opt.textContent = `${k.toUpperCase()} (${materialData[mat][k].widthFt} FT)`; t.appendChild(opt); 
        });
    }
}

function softReset() { 
    document.getElementById('height').value = ''; 
    document.getElementById('quoteResult').classList.add('hidden'); 
    document.getElementById('placeholder').classList.remove('hidden');
    document.getElementById('range').value = '';
    document.getElementById('range').disabled = false;
    ['materialType', 'height', 'range'].forEach(id => document.getElementById(id).classList.remove('error-shake'));
}

async function calculateQuote() {
    const els = { mat: document.getElementById('material'), type: document.getElementById('materialType'), h: document.getElementById('height'), u: document.getElementById('units'), r: document.getElementById('range') };

    let hasError = false;
    if(!els.type.value) { els.type.classList.add('error-shake'); hasError = true; }
    if(!els.h.value || parseFloat(els.h.value) <= 0) { els.h.classList.add('error-shake'); hasError = true; }
    if(!els.r.value) { els.r.classList.add('error-shake'); hasError = true; }
    if(hasError) { setTimeout(() => [els.type, els.h, els.r].forEach(el => el.classList.remove('error-shake')), 500); return; }

    const hIn = parseFloat(els.h.value);
    const unit = els.u.value;
    
    // 1. Convert Input to Meters
    let hM = hIn;
    if (unit === 'ft') hM = hIn * 0.3048; else if (unit === 'cm') hM = hIn / 100; else if (unit === 'mm') hM = hIn / 1000;
    
    // 2. Rounding Logic (Billed Length)
    let roundedM = hM <= 1 ? 1 : Math.ceil(hM * 2) / 2;
    
    // 3. Get Roll Width in Meters
    const rollWidthFt = materialData[els.mat.value][els.type.value].widthFt;
    const rollWidthM = rollWidthFt * 0.3048;

    // 4. Calculate Area (A.C.) -> Billed Height * Roll Width
    const areaSqM = (roundedM * rollWidthM).toFixed(2);

    // 5. Financials
    const priceVal = (roundedM * materialData[els.mat.value][els.type.value].prices[els.r.value]);
    const price = priceVal.toFixed(2);
    const taxPrice = (priceVal * 1.20).toFixed(2);

    // 6. Update Visualizer Shape
    updateVisualShape(rollWidthM, roundedM);

    // 7. Update UI Text
    let backConv;
    if (unit === 'mm') backConv = (roundedM * 1000).toFixed(0); else if (unit === 'cm') backConv = (roundedM * 100).toFixed(0); else if (unit === 'ft') backConv = (roundedM / 0.3048).toFixed(1); else backConv = roundedM.toFixed(1);

    document.getElementById('placeholder').classList.add('hidden');
    document.getElementById('quoteResult').classList.remove('hidden');
    
    // Update Data Fields
    document.getElementById('resRollWidth').innerText = `${rollWidthM.toFixed(2)} m`;
    document.getElementById('resArea').innerText = `${areaSqM} m¬≤`;
    document.getElementById('resRounded').innerText = `${roundedM.toFixed(1)}m (${backConv} ${unit})`;
    document.getElementById('resTotal').innerText = `¬£${price}`;
    document.getElementById('resTax').innerText = `¬£${taxPrice} (inc. TAX)`;
    
    // Update Visualizer Labels
    document.getElementById('visWidth').innerText = `${rollWidthM.toFixed(2)}m`;
    document.getElementById('visHeight').innerText = `${roundedM.toFixed(1)}m`;

    els.r.disabled = true;

    // 8. Save
    const saveStatus = document.getElementById('saveStatus');
    saveStatus.innerText = "Saving...";
    saveStatus.classList.remove('opacity-0', 'text-green-500', 'text-red-500');
    saveStatus.classList.add('text-slate-600');
    
    const details = `${roundedM.toFixed(1)}m x ${rollWidthM.toFixed(2)}m = ${areaSqM}m¬≤`;

    try {
        const { error } = await _supabase.from('quote_history').insert([{ 
            staff: session.staff, 
            customer: session.customer, 
            price: price, 
            total_with_tax: taxPrice, 
            details: details, 
            original: `${hIn} ${unit}`, 
            type: els.type.value, 
            range: els.r.value, 
            category: els.mat.value
        }]);

        if (error) throw error;
        saveStatus.innerText = "Saved ‚úÖ"; saveStatus.classList.add('text-green-500');
    } catch (err) {
        console.error("Save Error:", err);
        saveStatus.innerText = "Offline ‚ö†Ô∏è"; saveStatus.classList.add('text-red-500');
    }
}

function updateVisualShape(widthM, heightM) {
    const shape = document.getElementById('visualShape');
    // Calculate aspect ratio
    const ratio = widthM / heightM;
    
    // Base size for the container (pixels)
    const baseSize = 180; 
    
    let cssWidth, cssHeight;

    if (ratio > 1) {
        // Wider than tall (Landscape)
        cssWidth = baseSize;
        cssHeight = baseSize / ratio;
    } else {
        // Taller than wide (Portrait)
        cssHeight = baseSize;
        cssWidth = baseSize * ratio;
    }

    // Constraints to prevent it from getting too small to see
    if (cssWidth < 40) cssWidth = 40;
    if (cssHeight < 40) cssHeight = 40;

    shape.style.width = `${cssWidth}px`;
    shape.style.height = `${cssHeight}px`;
}
</script>
</body>
</html>